<div class="comments-section">
  <h3>Comments ({{ comments.length }})</h3>
  
  <div class="comment-form" *ngIf="isLoggedIn">
    <form [formGroup]="commentForm" (ngSubmit)="submitComment()">
      <textarea 
        formControlName="content" 
        placeholder="Add your comment..." 
        rows="3"
        [class.invalid]="commentForm.get('content')?.invalid && commentForm.get('content')?.touched"
      ></textarea>
      
      <div class="form-error" *ngIf="commentForm.get('content')?.invalid && commentForm.get('content')?.touched">
        <span *ngIf="commentForm.get('content')?.errors?.['required']">Comment cannot be empty</span>
        <span *ngIf="commentForm.get('content')?.errors?.['maxlength']">Comment is too long</span>
      </div>
      
      <button 
        type="submit" 
        [disabled]="commentForm.invalid || isSubmitting" 
        class="submit-btn"
      >
        {{ isSubmitting ? 'Posting...' : 'Post Comment' }}
      </button>
      
      <div class="error-message" *ngIf="commentError">{{ commentError }}</div>
    </form>
  </div>
  
  <div class="login-prompt" *ngIf="!isLoggedIn">
    <p>Please <a [routerLink]="['/auth/login']">login</a> to post comments.</p>
  </div>
  
  <div class="loading" *ngIf="loadingComments">
    <p>Loading comments...</p>
  </div>
  
  <div class="no-comments" *ngIf="!loadingComments && comments.length === 0">
    <p>No comments yet. Be the first to comment!</p>
  </div>
  
  <div class="comments-list" *ngIf="!loadingComments && comments.length > 0">
    <div class="comment" *ngFor="let comment of comments">
      <div class="comment-header">
        <div class="user-info">
          <img 
            class="user-avatar" 
            [src]="apiUrl + '/api/Image/get-user-image/' + comment.userId" 
            alt="User avatar"
            onerror="this.src='assets/images/default-avatar.png'"
          >
          <span class="comment-author">{{ comment.displayName }}</span>
        </div>
        <span class="comment-date">{{ formatDate(comment.publishedDate) }}</span>
      </div>
      
      <div class="comment-body">
        <p>{{ comment.content }}</p>
      </div>
      
      <div class="comment-footer">
        <div class="comment-actions">
        <button 
          class="like-btn" 
          [class.liked]="userLikedComments[comment.id]" 
          (click)="toggleLike(comment.id)"
          [disabled]="!isLoggedIn"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <span class="like-count">{{ comment.likes }}</span>
        </button>
        </div>
        
        <!-- Кнопка меню с тремя точками - перемещена в правый нижний угол -->
        <div class="options-btn-wrapper" *ngIf="isLoggedIn">
          <button 
            class="options-btn" 
            (click)="togglePopupMenu(comment.id, $event)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
              <circle cx="12" cy="6" r="2" />
              <circle cx="12" cy="12" r="2" />
              <circle cx="12" cy="18" r="2" />
            </svg>
          </button>
          
          <!-- Всплывающее меню -->
          <div 
            class="popup-menu" 
            *ngIf="activePopupCommentId === comment.id"
            (click)="$event.stopPropagation()"
          >
            <!-- Показывать пункт "Удалить" для всех комментариев пользователя -->
            <div 
              class="popup-menu-item" 
              (click)="deleteComment(comment.id, $event)"
              [class.deleting]="isDeletingComment === comment.id"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"></path>
                <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
              </svg>
              <span>{{ isDeletingComment === comment.id ? 'Deleting...' : 'Delete' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 