<div class="my-novels-container">
  <div class="my-novels-header">
    <h1>My Novels</h1>
    <div class="filter-controls">
      <div class="filter-group">
        <select [(ngModel)]="filters.status" (change)="applyFilters()">
          <option [ngValue]="undefined">All Statuses</option>
          <option *ngFor="let option of novelStatusOptions" [ngValue]="option.value">{{ option.label }}</option>
        </select>
      </div>
      
      <div class="filter-group">
        <select [(ngModel)]="filters.sortBy" (change)="applyFilters()">
          <option [ngValue]="undefined">Default Sort</option>
          <option value="popular">Most Popular</option>
          <option value="rating">Highest Rated</option>
          <option value="newest">Recently Added</option>
          <option value="a-z">A to Z</option>
        </select>
      </div>
      
      <button class="clear-filters-btn" *ngIf="hasActiveFilters()" (click)="clearFilters()">
        Clear Filters
      </button>
    </div>
    <button class="create-button" (click)="onCreateNovel()">Create New Novel</button>
  </div>

  <!-- Skeleton loader -->
  <div class="skeleton-loader" *ngIf="isLoading">
    <div class="novel-list">
      <div class="novel-item skeleton" *ngFor="let i of [1,2,3,4,5,6]">
        <div class="novel-item-content">
          <div class="novel-cover-skeleton shimmer-effect"></div>
          <div class="novel-content">
            <div class="novel-title-skeleton shimmer-effect"></div>
            <div class="novel-description-skeleton shimmer-effect"></div>
            <div class="novel-description-skeleton shimmer-effect" style="width: 85%;"></div>
            <div class="novel-description-skeleton shimmer-effect" style="width: 70%;"></div>
            <div class="novel-meta-skeleton">
              <div class="novel-genre-skeleton shimmer-effect"></div>
              <div class="novel-chapters-skeleton shimmer-effect"></div>
              <div class="novel-status-skeleton shimmer-effect"></div>
            </div>
          </div>
        </div>
        <div class="novel-actions-skeleton">
          <div class="action-btn-skeleton shimmer-effect"></div>
          <div class="action-btn-skeleton shimmer-effect"></div>
          <div class="action-btn-skeleton shimmer-effect"></div>
          <div class="action-btn-skeleton shimmer-effect"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="error-message general-error" *ngIf="errorMessage">
    <strong>Error:</strong> {{ errorMessage }}
  </div>

  <div class="success-message" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <div class="my-novels-content" *ngIf="!isLoading">
    <div class="empty-state" *ngIf="userNovels.length === 0">
      <div class="empty-state-icon">ðŸ“š</div>
      <h3>You haven't created any novels yet</h3>
      <p>Start creating your first novel and share your stories with the world.</p>
      <button class="create-button" (click)="onCreateNovel()">Create Your First Novel</button>
    </div>

    <div class="novel-list" *ngIf="userNovels.length > 0">
      <div class="novel-item" *ngFor="let novel of userNovels">
        <div class="novel-item-content">
          <div class="novel-cover">
            <div class="image-placeholder" [class.loaded]="isImageLoaded(novel.id)"></div>
            <img [src]="novel.imageUrl || '/assets/images/default-cover.png'" 
                 (error)="onImageError($event)" 
                 (load)="onImageLoad(novel.id!)"
                 [class.loaded]="isImageLoaded(novel.id)"
                 [alt]="novel.title">
          </div>
          <div class="novel-content">
            <h3 class="novel-title">{{ novel.title }}</h3>
            <p class="novel-description">{{ novel.description }}</p>
            <div class="novel-meta">
              <span class="novel-genre">{{ novel.genres?.join(', ') || novel.genre }}</span>
              <span class="novel-chapters">{{ novel.totalChapters || 0 }} chapters</span>
              <span class="novel-status" *ngIf="novel.status">
                <span class="status-badge" [ngClass]="getStatusClass(novel.status)">{{ getStatusText(novel.status) }}</span>
              </span>
              <span class="adult-content-badge" *ngIf="novel.isAdultContent">18+</span>
            </div>
          </div>
        </div>
        <div class="novel-actions">
          <button class="edit-button" (click)="showEditForm(novel)">Edit</button>
          <button class="delete-button" (click)="showDeleteConfirm(novel.id)">Delete</button>
          <button class="add-chapter-button" (click)="showAddChapterForm(novel)">Add Chapter</button>
          <button class="manage-chapters-button" (click)="showManageChapters(novel)">Manage Chapters</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Novel Form -->
  <div class="modal-overlay" *ngIf="editFormVisible" (click)="cancelEdit()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Edit Novel</h2>
        <button class="close-button" (click)="cancelEdit()">&times;</button>
      </div>
      <form [formGroup]="editForm" (ngSubmit)="updateNovel()">
        <div class="form-group">
          <label for="title">Title</label>
          <input 
            type="text" 
            id="title" 
            formControlName="title" 
            [class.is-invalid]="editForm.get('title')?.invalid && editForm.get('title')?.touched"
          />
          <div class="error-message" *ngIf="editForm.get('title')?.invalid && editForm.get('title')?.touched">
            <span *ngIf="editForm.get('title')?.errors?.['required']">Title is required</span>
            <span *ngIf="editForm.get('title')?.errors?.['minlength']">Title must be at least 3 characters</span>
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea 
            id="description" 
            formControlName="description" 
            rows="6"
            [class.is-invalid]="editForm.get('description')?.invalid && editForm.get('description')?.touched"
          ></textarea>
          <div class="error-message" *ngIf="editForm.get('description')?.invalid && editForm.get('description')?.touched">
            <span *ngIf="editForm.get('description')?.errors?.['required']">Description is required</span>
            <span *ngIf="editForm.get('description')?.errors?.['minlength']">Description must be at least 20 characters</span>
          </div>
        </div>

        <!-- Status field -->
        <div class="form-group">
          <label for="status">Status</label>
          
          <div class="status-selector">
            <div class="status-options">
              <div 
                *ngFor="let option of novelStatusOptions" 
                class="status-option" 
                [class.selected]="editForm.get('status')?.value == option.value"
                [ngClass]="getStatusClass(option.value)"
                (click)="setNovelStatus(option.value)"
              >
                <div class="status-icon">
                  <svg *ngIf="option.value === 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-2a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm1-8h4v2h-6V7h2v5z"/>
                  </svg>
                  <svg *ngIf="option.value === 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M8 17.85c1.275-.368 2.252-.913 3-1.651.748.738 1.725 1.283 3 1.65l-1.8 1.8a.5.5 0 0 0 .7.7l2.55-2.55a.5.5 0 0 0 0-.7L12.9 14.55a.5.5 0 0 0-.7.7l1.8 1.8a8.298 8.298 0 0 1-2-.958A8.298 8.298 0 0 1 10 17.05l1.8-1.8a.5.5 0 0 0-.7-.7l-2.55 2.55a.5.5 0 0 0 0 .7L11.1 20.3a.5.5 0 0 0 .7-.7L10 17.85zM18 18v-3h2v3h3v2h-3v3h-2v-3h-3v-2h3zM4 5v14h8v2H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h12a2 2 0 0 1 2 2v5h-2V5H4z"/>
                  </svg>
                  <svg *ngIf="option.value === 3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M20 2a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16zm-1 2H5v16h14V4zm-2 4v2h-3V8h3zm-5 0v2H9V8h3zm-5 0v2H6V8h2zm10 4v2h-3v-2h3zm-5 0v2H9v-2h3zm-5 0v2H6v-2h2zm8 4v2H6v-2h10z"/>
                  </svg>
                  <svg *ngIf="option.value === 4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-.997-4L6.76 11.757l1.414-1.414 2.829 2.829 5.656-5.657 1.415 1.414L11.003 16z"/>
                  </svg>
                </div>
                <div class="status-info">
                  <div class="status-name">{{ option.label }}</div>
                  <div class="status-description">
                    <ng-container [ngSwitch]="option.value">
                      <span *ngSwitchCase="1">Story is actively being updated</span>
                      <span *ngSwitchCase="2">Updates temporarily paused</span>
                      <span *ngSwitchCase="3">No longer being updated</span>
                      <span *ngSwitchCase="4">Story is finished</span>
                    </ng-container>
                  </div>
                </div>
                <div class="status-check">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-.997-4L6.76 11.757l1.414-1.414 2.829 2.829 5.656-5.657 1.415 1.414L11.003 16z"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>
          
          <select 
            id="status" 
            formControlName="status" 
            class="form-control visually-hidden"
            [class.is-invalid]="editForm.get('status')?.invalid && editForm.get('status')?.touched"
          >
            <option *ngFor="let option of novelStatusOptions" [value]="option.value">{{ option.label }}</option>
          </select>
          <div class="error-message" *ngIf="editForm.get('status')?.invalid && editForm.get('status')?.touched">
            <span *ngIf="editForm.get('status')?.errors?.['required']">Status is required</span>
          </div>
        </div>

        <!-- Adult Content field -->
        <div class="form-group">
          <div class="adult-content-toggle">
            <div class="toggle-container">
              <input 
                class="toggle-input" 
                type="checkbox" 
                id="isAdultContent"
                formControlName="isAdultContent"
              >
              <label class="toggle-label" for="isAdultContent">
                <span class="toggle-button"></span>
              </label>
            </div>
            <div class="toggle-content">
              <h4>Adult Content</h4>
              <p>This novel contains adult themes (18+)</p>
            </div>
          </div>
          <div class="age-verification-note">
            <div class="note-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
              </svg>
            </div>
            <p>Adult content will only be accessible to users who have verified their age as 18+</p>
          </div>
        </div>

        <!-- Cover Image upload field -->
        <div class="form-group">
          <label for="coverImage">Cover Image</label>
          <div class="image-upload-container" 
               (dragover)="onDragOver($event)" 
               (dragleave)="onDragLeave($event)" 
               (drop)="onDrop($event)"
               [class.drag-active]="isDragging">
            <div class="upload-area">
              <div *ngIf="!imagePreview" class="upload-placeholder">
                <div class="upload-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </div>
                <p class="upload-text">Drag and drop an image<br>or <span class="browse-text">browse to upload</span>.</p>
                <button type="button" class="upload-button" (click)="triggerFileInput()">Upload your photo</button>
                <p class="upload-requirements">File must be JPG or PNG and up to 40MB</p>
                <div class="upload-features">
                  <span class="feature-item">âœ“ Free to use</span>
                  <span class="feature-item">âœ“ No credit card required</span>
                </div>
              </div>
              <img *ngIf="imagePreview" [src]="imagePreview" alt="Cover preview" class="preview-image">
              <button *ngIf="imagePreview" type="button" class="remove-image-btn" (click)="removeImage()">Remove</button>
            </div>
            <input 
              #fileInput
              type="file" 
              id="coverImage" 
              class="file-input" 
              accept="image/jpeg,image/png"
              (change)="onFileSelected($event)"
              hidden
            />
          </div>
          <small class="form-text text-muted">Recommended size: 300x450 pixels (will be automatically resized to fit)</small>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-button" (click)="cancelEdit()">Cancel</button>
          <button type="submit" class="save-button" [disabled]="editForm.invalid || isLoading">
            {{ isLoading ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
        
        <!-- Debug information -->
        <div *ngIf="editForm.invalid" class="error-message" style="margin-top: 10px; padding: 10px;">
          <strong>Form is invalid:</strong>
          <ul>
            <li *ngIf="editForm.get('title')?.invalid">
              Title errors: {{ editForm.get('title')?.errors | json }}
            </li>
            <li *ngIf="editForm.get('description')?.invalid">
              Description errors: {{ editForm.get('description')?.errors | json }}
            </li>
            <li *ngIf="editForm.get('status')?.invalid">
              Status errors: {{ editForm.get('status')?.errors | json }}
            </li>
          </ul>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Chapter Form -->
  <div class="modal-overlay" *ngIf="addChapterFormVisible" (click)="cancelAddChapter()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Chapter</h2>
        <button class="close-button" (click)="cancelAddChapter()">&times;</button>
      </div>
      <form [formGroup]="chapterForm" (ngSubmit)="addChapter()">
        <div class="form-group">
          <label for="chapterTitle">Chapter Title</label>
          <input 
            type="text" 
            id="chapterTitle" 
            formControlName="title" 
            [class.is-invalid]="chapterForm.get('title')?.invalid && chapterForm.get('title')?.touched"
          />
          <div class="error-message" *ngIf="chapterForm.get('title')?.invalid && chapterForm.get('title')?.touched">
            <span *ngIf="chapterForm.get('title')?.errors?.['required']">Title is required</span>
            <span *ngIf="chapterForm.get('title')?.errors?.['minlength']">Title must be at least 3 characters</span>
          </div>
        </div>

        <div class="form-group">
          <label for="chapterContent">Chapter Content</label>
          <textarea 
            id="chapterContent" 
            formControlName="content" 
            rows="15"
            [class.is-invalid]="chapterForm.get('content')?.invalid && chapterForm.get('content')?.touched"
          ></textarea>
          <div class="error-message" *ngIf="chapterForm.get('content')?.invalid && chapterForm.get('content')?.touched">
            <span *ngIf="chapterForm.get('content')?.errors?.['required']">Content is required</span>
            <span *ngIf="chapterForm.get('content')?.errors?.['minlength']">Content must be at least 50 characters</span>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-button" (click)="cancelAddChapter()">Cancel</button>
          <button type="submit" class="save-button" [disabled]="chapterForm.invalid || isLoading">
            {{ isLoading ? 'Adding...' : 'Add Chapter' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Chapters Dialog -->
  <div class="modal-overlay" *ngIf="manageChaptersVisible" (click)="cancelManageChapters()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Manage Chapters</h2>
        <button class="close-button" (click)="cancelManageChapters()">&times;</button>
      </div>
      
      <div class="modal-body">
        <!-- Chapter loading skeleton -->
        <div class="chapters-loading-skeleton" *ngIf="isLoadingChapters">
          <div class="chapter-item-skeleton" *ngFor="let i of [1,2,3,4,5]">
            <div class="chapter-info-skeleton">
              <div class="chapter-number-skeleton shimmer-effect"></div>
              <div class="chapter-title-skeleton shimmer-effect"></div>
              <div class="chapter-date-skeleton shimmer-effect"></div>
            </div>
            <div class="chapter-actions-skeleton">
              <div class="delete-chapter-btn-skeleton shimmer-effect"></div>
            </div>
          </div>
        </div>

        <div class="empty-chapters" *ngIf="!isLoadingChapters && novelChapters.length === 0">
          <p>This novel doesn't have any chapters yet.</p>
          <button class="add-chapter-button-inline" (click)="showAddChapterForm(selectedNovel!)" *ngIf="selectedNovel">Add First Chapter</button>
        </div>

        <div class="chapters-list" *ngIf="!isLoadingChapters && novelChapters.length > 0">
          <div class="chapter-item" *ngFor="let chapter of novelChapters">
            <div class="chapter-info">
              <span class="chapter-number">Chapter {{ chapter.chapterNumber }}</span>
              <span class="chapter-title">{{ chapter.title }}</span>
              <span class="chapter-date" *ngIf="chapter.createdAt">{{ chapter.createdAt | timeAgo }}</span>
            </div>
            <div class="chapter-actions">
              <button class="delete-chapter-button" (click)="showDeleteChapterConfirm(chapter)">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="cancel-button" (click)="cancelManageChapters()">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Chapter Confirmation Dialog -->
  <div class="modal-overlay" *ngIf="deleteChapterConfirmVisible" (click)="cancelDeleteChapter()">
    <div class="modal-content delete-confirm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Delete Chapter</h2>
        <button class="close-button" (click)="cancelDeleteChapter()">&times;</button>
      </div>
      <div class="delete-message">
        <p>Are you sure you want to delete Chapter {{ selectedChapter?.chapterNumber }}: "{{ selectedChapter?.title }}"?</p>
        <p>This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button class="cancel-button" (click)="cancelDeleteChapter()">Cancel</button>
        <button class="delete-button confirm" (click)="deleteChapter()" [disabled]="isLoading">
          {{ isLoading ? 'Deleting...' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Novel Confirmation Dialog -->
  <div class="modal-overlay" *ngIf="deleteConfirmVisible" (click)="cancelDelete()">
    <div class="modal-content delete-confirm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Delete Novel</h2>
        <button class="close-button" (click)="cancelDelete()">&times;</button>
      </div>
      <div class="delete-message">
        <p>Are you sure you want to delete this novel? This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button class="cancel-button" (click)="cancelDelete()">Cancel</button>
        <button class="delete-button confirm" (click)="deleteNovel()" [disabled]="isLoading">
          {{ isLoading ? 'Deleting...' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>
</div>
