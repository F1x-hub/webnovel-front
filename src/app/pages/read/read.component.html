<div class="container">
  <div *ngIf="loading" class="loading">
    <p>Loading chapter...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ errorMessage || 'Error loading chapter. Please try again later.' }}</p>
    <button class="btn" routerLink="/browse">Back to Browse</button>
  </div>

  <!-- Update the notification message to have different icons for adding/removing bookmark -->
  <div *ngIf="showMarkReadNotification" class="read-notification">
    <div class="notification-content" [ngClass]="{'notification-success': isLastReadChapter, 'notification-info': !isLastReadChapter}">
      <svg *ngIf="isLastReadChapter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      <svg *ngIf="!isLastReadChapter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <span>{{ isLastReadChapter ? 'Chapter marked as your current reading position' : 'Reading position removed' }}</span>
    </div>
  </div>

  <div *ngIf="chapter && !loading && !error" class="chapter-container">
    <div class="novel-chapter-header">
      <h1>
        <a [routerLink]="['/novel', novelId]" class="novel-title">{{ novelTitle }}</a> / Chapter {{ chapterNumber }} â€” {{ chapter.title }}
      </h1>
      <!-- Mark as last read button - uses direct API endpoint check for current chapter status -->
      <button 
          *ngIf="authService.currentUserValue"
          class="btn icon-btn mark-read-btn" 
          [class.active]="isLastReadChapter"
          (click)="markAsLastRead()"
          aria-label="Mark as Last Read"
          title="{{isLastReadChapter ? 'Current Read Chapter' : 'Mark as Last Read'}}"
        >
          <!-- Bookmark icon (default) -->
          <svg *ngIf="!isLastReadChapter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
          <!-- Checkmark icon (when active) -->
          <svg *ngIf="isLastReadChapter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="checkmark-icon">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </button>
    </div>
    
    <div class="chapter-header">
      <div class="chapter-navigation">
        <button 
          class="nav-btn prev-btn" 
          [disabled]="!hasPreviousChapter()" 
          (click)="previousChapter()"
          aria-label="Previous Chapter"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <span class="chapter-info">Chapter {{ chapterNumber }} / {{ totalChapters }}</span>
        <button 
          class="nav-btn next-btn" 
          [disabled]="!hasNextChapter()"
          (click)="nextChapter()"
          aria-label="Next Chapter"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
      
      <h1 class="chapter-title">{{ chapter.title }}</h1>
    </div>
    
    <div class="chapter-content">
      <div [innerHTML]="chapter.content | safeHtml"></div>
    </div>
    
    <div class="chapter-footer">
      <div class="chapter-navigation">
        <button 
          class="nav-btn prev-btn" 
          [disabled]="!hasPreviousChapter()" 
          (click)="previousChapter()"
          aria-label="Previous Chapter"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button 
          class="nav-btn next-btn"
          [disabled]="!hasNextChapter()" 
          (click)="nextChapter()"
          aria-label="Next Chapter"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
      
      <div class="chapter-actions">
        
        <a (click)="goBack()" class="btn secondary-btn">Back to Novel</a>
        <!-- Mark as last read button (footer) - uses direct API endpoint check for current chapter status -->
        <button 
          *ngIf="authService.currentUserValue"
          class="btn icon-btn mark-read-btn" 
          [class.active]="isLastReadChapter"
          (click)="markAsLastRead()"
          aria-label="Mark as Last Read"
          title="{{isLastReadChapter ? 'Current Read Chapter' : 'Mark as Last Read'}}"
        >
          <!-- Bookmark icon (default) -->
          <svg *ngIf="!isLastReadChapter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
          <!-- Checkmark icon (when active) -->
          <svg *ngIf="isLastReadChapter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="checkmark-icon">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </button>
      </div>
    </div>
    
    <app-chapter-comments [chapterId]="chapter.id"></app-chapter-comments>
  </div>
</div>
